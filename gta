#!/bin/bash

# Git Terminal Assistant (GTA) - Global Command
# This script allows calling the assistant from anywhere in the system

# Resolve this script's real path even if called via a symlink
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
  LINK_TARGET="$(readlink "$SCRIPT_PATH")"
  if [[ "$LINK_TARGET" == /* ]]; then
    SCRIPT_PATH="$LINK_TARGET"
  else
    SCRIPT_DIR_TMP="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$SCRIPT_DIR_TMP/$LINK_TARGET"
  fi
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

# Load environment variables from .env if present
DOTENV_PATH="$SCRIPT_DIR/.env"
if [ -f "$DOTENV_PATH" ]; then
    # export variables defined in .env
    set -a
    # shellcheck disable=SC1090
    source "$DOTENV_PATH"
    set +a
    echo "Loaded environment from $DOTENV_PATH"
    echo "Using provider: $LLM_PROVIDER with model: $LLM_MODEL"
fi

# Path to the main Python script
MAIN_SCRIPT="$SCRIPT_DIR/main.py"

# Try common virtual environment locations (venv, .venv)
VENV1="$SCRIPT_DIR/venv"
VENV2="$SCRIPT_DIR/.venv"
ACTIVATE=""
if [ -d "$VENV1" ]; then
    ACTIVATE="$VENV1/bin/activate"
elif [ -d "$VENV2" ]; then
    ACTIVATE="$VENV2/bin/activate"
fi

if [ -n "$ACTIVATE" ] && [ -f "$ACTIVATE" ]; then
    echo "Activating virtual environment: $(dirname "$ACTIVATE")"
    # shellcheck disable=SC1090
    source "$ACTIVATE"
    python "$MAIN_SCRIPT" "$@"
    deactivate
else
    # Try to run without virtual environment (fallback)
    echo "Warning: Virtual environment not found at $VENV1 or $VENV2"
    echo "Attempting to run with system Python..."
    python3 "$MAIN_SCRIPT" "$@"
fi
 